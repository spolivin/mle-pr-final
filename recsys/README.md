# Modeling experiments

Данная директория посвящена проведению исследовательского анализа данных с последующим запуском ряда экспериментов в среде *Mlflow* с хранилищем артефактов. 

## Directory structure

Здесь хранятся следующие файлы и папки:

| Element | Description |
| :---   | :--- |
| [`recommendation_system.ipynb`](./recommendation_system.ipynb)| Тетрадка с EDA и запуском экспериментов |
| [`assets`](./assets/)| Папка с артефактами для логирования в *Mlflow* |
| [`model_comparison`](./model_comparison/)| Папка с визуализациями сравнения разных ранжирующих моделей |
| [`run_jupyter_server.sh`](./run_jupyter_server.sh)| Скрипт для запуска сервера *Jupyter* |
| [`run_mlflow_server.sh`](./run_mlflow_server.sh)| Скрипт для запуска сервиса *Mlflow* с хранилищем артефактов |

Отметим, что часть логируемых артефактов сохраняется в директории [assets](./assets/), в том время как другая часть представляет собой данные в формате `parquet`, которые не отслеживаются *Git* ради сохранения относительно небольшого размера репозитория.

## Виртуальное окружение

Перед запуском кода в тетрадке, нужно сначала создать виртуальное окружение следующими командами из корневой директории:

```bash
# Preparing virtual env
sudo apt-get update
sudo apt-get install python3.10-venv
python3.10 -m venv .venv_recsys
source .venv_recsys/bin/activate
pip install -r requirements.txt
```

## Запуск сервера *Mlflow*
Сервис *Mlflow* запускается следующим образом:

```bash
cd recsys
sh run_mlflow_server.sh
```

>Note: В случае успешного запуска сервис экспериментов будет доступен по адресу http://localhost:5000

## Запуск сервера *Jupyter*

В данной папке также присутствует скрипт для запуска *Jupyter* на сервере, что можно реализовать так:

```bash
cd recsys
sh run_jupyter_server.sh
```

>Note: В случае успешного запуска сервер будет доступен по адресу http://localhost:8888

## Сохранение рекомендаций и кандидатов для моделирования

В процессе выполнения кода в тетрадке, будут постепенно создаваться следующие файлы с данными:

* `top_popular.parquet` => Топ-100 товаров (дефолтные рекомендации)
* `similar.parquet` => Схожие товары (онлайн рекомендации)
* `candidates_train.parquet` => Кандидаты (рекомендации) для тренировки ранжирующей модели
* `candidates_inference.parquet` => Кандидаты для ранжирования
* `catboost_model.cmb` => Наилучшая по метрикам качества катбуст-модель

> Note: Данные файлы не отслеживаются и не видны в репозитории

Файлы будут сохраняться в директории [postgres_data](../airflow_service/postgres_data/), откуда они будут посредством выполнения *DAG*-ов загружаться в базу данных, а далее использоваться либо для переобучения ранжирующей модели, либо в веб-сервисе. Данный шаг предусмотрен для сохранения данных не только в *S3*, но и в базе данных, откуда они будут выгружаться для других задач.
